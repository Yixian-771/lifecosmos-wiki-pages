name: Deploy wiki pages to server

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ðŸ”¥ æ–°å¢žï¼šå®‰è£… Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ðŸ”¥ æ–°å¢žï¼šå®‰è£… MkDocs
      - name: Install MkDocs
        run: |
          pip install --upgrade pip
          pip install mkdocs mkdocs-material pymdown-extensions

      # ðŸ”¥ æ–°å¢žï¼šæž„å»ºä¸­æ–‡
      - name: Build ZH
        run: mkdocs build -f mkdocs.zh.yml

      # ðŸ”¥ æ–°å¢žï¼šæž„å»ºè‹±æ–‡
      - name: Build EN
        run: mkdocs build -f mkdocs.en.yml

      # ðŸ”¥ æ–°å¢žï¼šé¦–é¡µè·³è½¬
      - name: Create root index.html
        run: |
          mkdir -p site
          cat > site/index.html <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=/zh/">
          <title>Lifechanyuan Wiki</title>
          <a href="/zh/">Go to /zh/</a>
          HTML

      # ä¿ç•™ä½ åŽŸæ¥çš„ rsync + ssh éƒ¨åˆ†
      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

      - name: Setup SSH
        shell: bash
        run: |
          set -e
          PORT="${{ secrets.DEPLOY_PORT }}"
          if [ -z "$PORT" ]; then PORT="22"; fi

          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh-keyscan -p "$PORT" -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy via rsync
        run: |
          PORT="${{ secrets.DEPLOY_PORT }}"
          if [ -z "$PORT" ]; then PORT="22"; fi

          rsync -avz --delete \
            --exclude='.well-known/' \
            -e "ssh -p $PORT -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" \
            site/ \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/www/wwwroot/wiki-static/
